<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant IA - Maintenance Agroalimentaire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        .sidebar h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 3px solid #2a5298;
            padding-bottom: 10px;
        }

        .quick-action {
            background: #f0f4f8;
            border: 2px solid #e0e7ef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action:hover {
            background: #e3edf7;
            border-color: #2a5298;
            transform: translateX(5px);
        }

        .quick-action h3 {
            color: #1e3c72;
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px 30px;
            border-bottom: 4px solid #f39c12;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .stats-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e7ef;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #1e3c72;
            border-bottom-color: #2a5298;
            background: white;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .chat-container {
            padding: 25px;
            background: #f8f9fa;
            min-height: 100%;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #2a5298;
        }

        .message.assistant .message-avatar {
            background: #27ae60;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 15px;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: #2a5298;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e7ef;
            border-bottom-left-radius: 5px;
        }

        .input-area {
            padding: 20px 25px;
            background: white;
            border-top: 2px solid #e0e7ef;
        }

        .input-container {
            display: flex;
            gap: 12px;
        }

        #userInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e7ef;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        #userInput:focus {
            border-color: #2a5298;
        }

        #sendBtn {
            padding: 15px 35px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        #sendBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        #sendBtn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1e3c72;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e7ef;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            margin-left: 10px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e7ef;
        }

        .data-table th {
            background: #f0f4f8;
            color: #1e3c72;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .machine-card {
            background: white;
            border: 2px solid #e0e7ef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .machine-card:hover {
            border-color: #2a5298;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .machine-card h4 {
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .loading-dots span {
            animation: blink 1.4s infinite;
            font-size: 1.5em;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        .welcome-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .welcome-message h2 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e7ef;
            border-radius: 25px;
            font-size: 1em;
        }

        .analysis-section {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .analysis-section h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .panne-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #2a5298;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .export-section {
            margin-top: 20px;
            padding: 20px;
            background: #f0f4f8;
            border-radius: 10px;
        }

        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>üîß Actions Rapides</h2>
            
            <div class="quick-action" onclick="showTab('chat')">
                <h3>üí¨ Assistant IA</h3>
            </div>

            <div class="quick-action" onclick="showTab('machines')">
                <h3>üè≠ Liste des Machines</h3>
            </div>

            <div class="quick-action" onclick="showTab('add')">
                <h3>‚ûï Ajouter une Panne</h3>
            </div>

            <div class="quick-action" onclick="showTab('history')">
                <h3>üìä Historique Complet</h3>
            </div>

            <div class="quick-action" onclick="askQuestion('Quelles sont les pannes les plus fr√©quentes ?')">
                <h3>üìà Pannes Fr√©quentes</h3>
            </div>

            <div class="quick-action" onclick="askQuestion('Conseils de maintenance pr√©ventive')">
                <h3>üõ°Ô∏è Maintenance Pr√©ventive</h3>
            </div>

            <div class="quick-action" onclick="showTab('export')">
                <h3>üíæ Export / Import</h3>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>ü§ñ Assistant IA - Maintenance Domagn√©</h1>
                <p>Syst√®me de gestion sans base de donn√©es</p>
                <div class="stats-badge" id="statsBadge">
                    üìä Chargement...
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('chat')">üí¨ Assistant IA</button>
                <button class="tab" onclick="showTab('machines')">üè≠ Machines</button>
                <button class="tab" onclick="showTab('add')">‚ûï Ajouter</button>
                <button class="tab" onclick="showTab('history')">üìä Historique</button>
                <button class="tab" onclick="showTab('export')">üíæ Export</button>
            </div>

            <!-- Tab Chat -->
            <div id="chatTab" class="tab-content active">
                <div class="chat-container" id="chatContainer">
                    <div class="welcome-message">
                        <h2>Bienvenue sur votre assistant de maintenance !</h2>
                        <p>Stockage local dans votre navigateur (localStorage).</p>
                        <p><strong>Exemples :</strong></p>
                        <p>‚Ä¢ "Historique du Pasteurisateur"</p>
                        <p>‚Ä¢ "Probl√®mes de temp√©rature"</p>
                        <p>‚Ä¢ "Maintenance pr√©ventive"</p>
                    </div>
                </div>
                <div class="loading" id="loading">
                    <div class="loading-dots">
                        <span>‚Ä¢</span>
                        <span>‚Ä¢</span>
                        <span>‚Ä¢</span>
                    </div>
                    L'assistant analyse...
                </div>
                <div class="input-area">
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="userInput" 
                            placeholder="Posez votre question..."
                            onkeypress="if(event.key === 'Enter') sendMessage()"
                        >
                        <button id="sendBtn" onclick="sendMessage()">Envoyer</button>
                    </div>
                </div>
            </div>

            <!-- Tab Machines -->
            <div id="machinesTab" class="tab-content">
                <div style="padding: 25px;">
                    <h2>Liste des Machines</h2>
                    <div class="search-box">
                        <input type="text" id="machineSearch" placeholder="üîç Rechercher..." onkeyup="filterMachines()">
                    </div>
                    <div id="machinesList"></div>
                </div>
            </div>

            <!-- Tab Ajout -->
            <div id="addTab" class="tab-content">
                <div style="padding: 25px;">
                    <h2>Ajouter une Panne</h2>
                    <div id="addAlert"></div>
                    <form id="breakdownForm" onsubmit="addBreakdown(event)">
                        <div class="form-group">
                            <label>Nom de la Machine *</label>
                            <input type="text" id="machineName" required placeholder="Ex: Pasteurisateur">
                        </div>
                        <div class="form-group">
                            <label>Probl√®me Rencontr√© *</label>
                            <textarea id="problem" required placeholder="D√©crivez le probl√®me..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Cause *</label>
                            <textarea id="cause" required placeholder="Cause identifi√©e..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>R√©solution *</label>
                            <textarea id="resolution" required placeholder="Solution appliqu√©e..."></textarea>
                        </div>
                        <button type="submit" class="btn">üìù Enregistrer</button>
                    </form>
                </div>
            </div>

            <!-- Tab Historique -->
            <div id="historyTab" class="tab-content">
                <div style="padding: 25px;">
                    <h2>Historique des Pannes</h2>
                    <button class="btn" onclick="loadHistory()">üîÑ Actualiser</button>
                    <div id="historyList"></div>
                </div>
            </div>

            <!-- Tab Export -->
            <div id="exportTab" class="tab-content">
                <div style="padding: 25px;">
                    <h2>Export / Import des Donn√©es</h2>
                    
                    <div class="export-section">
                        <h3>üì• Exporter les Donn√©es</h3>
                        <p>T√©l√©chargez vos donn√©es pour les sauvegarder ou les transf√©rer.</p>
                        <button class="btn" onclick="exportJSON()">üíæ Exporter en JSON</button>
                        <button class="btn" onclick="exportCSV()">üìä Exporter en CSV</button>
                        <button class="btn" onclick="exportSQL()">üóÑÔ∏è Exporter en SQL</button>
                    </div>

                    <div class="export-section">
                        <h3>üì§ Importer des Donn√©es</h3>
                        <p>Importez un fichier JSON pr√©c√©demment export√©.</p>
                        <input type="file" id="importFile" accept=".json" style="margin-bottom: 10px;">
                        <button class="btn" onclick="importJSON()">üìÇ Importer JSON</button>
                    </div>

                    <div class="export-section">
                        <h3>üóëÔ∏è Gestion des Donn√©es</h3>
                        <p>R√©initialiser ou supprimer toutes les donn√©es.</p>
                        <button class="btn" onclick="resetData()">üîÑ R√©initialiser (donn√©es exemple)</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Tout Supprimer</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Gestionnaire de base de donn√©es localStorage
        class Database {
            constructor() {
                this.storageKey = 'maintenance_pannes';
                this.data = this.load();
                if (this.data.length === 0) {
                    this.initDefaultData();
                }
                this.updateStats();
            }

            load() {
                const saved = localStorage.getItem(this.storageKey);
                return saved ? JSON.parse(saved) : [];
            }

            save() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                this.updateStats();
            }

            initDefaultData() {
                this.data = [
                    // Donn√©es du d√©palettiseur
                    {
                        id: 1,
                        machine_name: 'D√©palettiseur',
                        problem: 'D√©faut cellules "time out"',
                        cause: 'Cellules obstru√©es ou mal align√©es',
                        resolution: 'Nettoyage des cellules et r√©alignement, v√©rification du c√¢blage',
                        date_created: '2026-02-11 12:00:00'
                    },
                    {
                        id: 2,
                        machine_name: 'D√©palettiseur',
                        problem: 'D√©faut noeud profinet',
                        cause: 'D√©faillance du c√¢ble profinet ou de l\'actionneur associ√©',
                        resolution: 'Remplacement du c√¢ble ou de l\'actionneur d√©fectueux',
                        date_created: '2026-02-11 12:00:00'
                    },
                    {
                        id: 3,
                        machine_name: 'D√©palettiseur',
                        problem: 'Les caisses sont mal √©vacu√©es',
                        cause: 'D√©faillance d\'une ou plusieurs cellules ou probl√®me de temporisation ou de vitesse du convoyeur',
                        resolution: 'V√©rification et nettoyage des cellules ou ajustement de la temporisation ou de la vitesse du convoyeur',
                        date_created: '2026-02-11 12:00:00'
                    },

                    // Donn√©es de la d√©caisseuse
                    {
                        id: 4,
                        machine_name: 'D√©caisseuse',
                        problem: 'Probl√®me de blocage caisses',
                        cause: 'Cellules de d√©tection des caisses encrass√©es ou us√©es ou mal r√©gler',
                        resolution: 'Nettoyage ou remplacement ou r√©glage des cellules de d√©tection',
                        date_created: '2026-02-11 12:00:00'
                    },
                    {
                        id: 5,
                        machine_name: 'D√©caisseuse',
                        problem: 'T√™te de d√©caisseuse bloqu√©e',
                        cause: 'D√©tection d\'obstacle sur la t√™te de d√©caisseuse',
                        resolution: 'V√©rification du capteur et/ou retrait de l\'obstacle',
                        date_created: '2026-02-11 12:00:00'
                    },

                    // Donn√©es de la laveuse
                    {
                        id: 6,
                        machine_name: 'Laveuse de bouteilles',
                        problem: 'D√©faut de dosage de lessive',
                        cause: 'Pompe doseuse d√©fectueuse ou tuyau d\'alimentation bouch√© ou d√©samorc√©',
                        resolution: 'V√©rification de l\'amor√ßage de la pompe doseuse ou nettoyage du tuyau d\'alimentation ou remplacement de la pompe doseuse',
                        date_created: '2026-02-11 12:00:00'
                    },
                    {
                        id: 7,
                        machine_name: 'Laveuse de bouteilles',
                        problem: 'Pr√©sence de bouteilles dans les bains de rin√ßage',
                        cause: 'Alv√©oles endommag√©es ou d√©fectueuses',
                        resolution: 'Remplacement des alv√©oles endommag√©es ou d√©fectueuses',
                        date_created: '2026-02-11 12:00:00'
                    },

                    // Donn√©es de la rin√ßeuse
                    {
                        id: 8,
                        machine_name: 'Rin√ßeuse',
                        problem: 'Les robinets de rin√ßage ne s\'ouvrent pas',
                        cause: 'D√©faillance de la bobine √©lectromagn√©tique ou du capteur de bouteille ou relais de commande d√©fectueux',
                        resolution: 'V√©rification et remplacement de la bobine √©lectromagn√©tique ou du capteur de bouteille ou relais de commande d√©fectueux',
                        date_created: '2026-02-11 12:00:00'
                    },
                       {
                        id: 9,
                        machine_name: 'Rin√ßeuse',
                        problem: 'Certaines bobines de rin√ßage ne fonctionnent pas',
                        cause: 'D√©faillance de la bobine de rin√ßage',
                        resolution: 'Remplacement de la bobine de rin√ßage d√©fectueuse',
                        date_created: '2026-02-11 12:00:00'
                    },

                    // Donn√©es de l'√©tiqueteuse'
                       {
                        id: 10,
                        machine_name: '√âtiqueteuse',
                        problem: '√âtiquette non coll√©e',
                        cause: 'D√©faillance du syst√®me de collage',
                        resolution: 'V√©rification et remplacement du syst√®me de collage d√©fectueux',
                        date_created: '2026-02-11 12:00:00'
                    },
                       {
                        id: 11,
                        machine_name: '√âtiqueteuse',
                        problem: '√âtiquette mal positionn√©e',
                        cause: 'D√©faillance du syst√®me de positionnement',
                        resolution: 'V√©rification et remplacement du syst√®me de positionnement d√©fectueux',
                        date_created: '2026-02-11 12:00:00'
                    }
                    
                ];
                this.save();
            }

            getAll() {
                return this.data;
            }

            getByMachine(machineName) {
                return this.data.filter(item => 
                    item.machine_name.toLowerCase().includes(machineName.toLowerCase())
                );
            }

            add(item) {
                const id = this.data.length > 0 ? Math.max(...this.data.map(d => d.id)) + 1 : 1;
                const newItem = {
                    id,
                    ...item,
                    date_created: new Date().toISOString().slice(0, 19).replace('T', ' ')
                };
                this.data.unshift(newItem);
                this.save();
                return newItem;
            }

            delete(id) {
                this.data = this.data.filter(item => item.id !== id);
                this.save();
            }

            getMachineNames() {
                const names = [...new Set(this.data.map(d => d.machine_name))];
                return names.sort();
            }

            search(query) {
                query = query.toLowerCase();
                return this.data.filter(item => 
                    item.machine_name.toLowerCase().includes(query) ||
                    item.problem.toLowerCase().includes(query) ||
                    item.cause.toLowerCase().includes(query) ||
                    item.resolution.toLowerCase().includes(query)
                );
            }

            updateStats() {
                const badge = document.getElementById('statsBadge');
                if (badge) {
                    badge.textContent = `üìä ${this.data.length} pannes ‚Ä¢ ${this.getMachineNames().length} machines`;
                }
            }

            clear() {
                this.data = [];
                this.save();
            }

            reset() {
                this.data = [];
                this.initDefaultData();
            }

            exportData() {
                return this.data;
            }

            importData(data) {
                this.data = data;
                this.save();
            }
        }

        const db = new Database();

        // Assistant IA Local
        class LocalAI {
            analyzeQuery(query) {
                const machines = db.getMachineNames();
                let machineFound = null;

                for (let machine of machines) {
                    if (query.toLowerCase().includes(machine.toLowerCase())) {
                        machineFound = machine;
                        break;
                    }
                }

                if (machineFound) {
                    return this.generateMachineReport(machineFound);
                }

                if (query.match(/temp√©rature|thermique|chaleur|froid/i)) {
                    return this.searchByKeyword('temp√©rature');
                }

                if (query.match(/pression|fuite|circuit/i)) {
                    return this.searchByKeyword('pression');
                }

                if (query.match(/capteur|sonde|d√©tecteur/i)) {
                    return this.searchByKeyword('capteur');
                }

                if (query.match(/maintenance|entretien|pr√©ventive/i)) {
                    return this.getMaintenanceAdvice();
                }

                if (query.match(/fr√©quent|r√©current|souvent|statistique/i)) {
                    return this.getFrequentIssues();
                }

                return this.getGeneralHelp();
            }

            generateMachineReport(machineName) {
                const pannes = db.getByMachine(machineName);

                if (pannes.length === 0) {
                    return `<strong>Machine : ${machineName}</strong><br><br>Aucune panne enregistr√©e pour cette machine.`;
                }

                let response = `<div class="analysis-section">
                    <h4>üìä Analyse : ${machineName}</h4>
                    <p><strong>Total de pannes :</strong> ${pannes.length}</p>
                </div>`;

                response += `<h4>üîç Historique des Pannes :</h4>`;

                pannes.forEach((panne, index) => {
                    response += `
                        <div class="panne-item">
                            <strong>Panne #${index + 1}</strong> - ${new Date(panne.date_created).toLocaleDateString('fr-FR')}<br>
                            <strong>Probl√®me :</strong> ${panne.problem}<br>
                            <strong>Cause :</strong> ${panne.cause}<br>
                            <strong>‚úÖ R√©solution :</strong> ${panne.resolution}
                        </div>
                    `;
                });

                const causes = pannes.map(p => p.cause.toLowerCase());
                const hasTempIssues = causes.some(c => c.includes('temp√©rature') || c.includes('sonde'));
                const hasMechIssues = causes.some(c => c.includes('roulement') || c.includes('courroie'));

                if (pannes.length > 1) {
                    response += `<div class="analysis-section">
                        <h4>üí° Recommandations :</h4>`;
                    
                    if (hasTempIssues) {
                        response += `<p>‚Ä¢ V√©rifier r√©guli√®rement les sondes de temp√©rature (calibration mensuelle recommand√©e)</p>`;
                    }
                    if (hasMechIssues) {
                        response += `<p>‚Ä¢ Planifier une maintenance pr√©ventive des √©l√©ments m√©caniques</p>`;
                    }
                    
                    response += `<p>‚Ä¢ Documenter toutes les interventions pour suivre l'√©volution</p>
                        <p>‚Ä¢ Former les techniciens aux sp√©cificit√©s de cette machine</p>
                    </div>`;
                }

                return response;
            }

            searchByKeyword(keyword) {
                const results = db.search(keyword);
                
                if (results.length === 0) {
                    return `Aucune panne trouv√©e concernant : <strong>${keyword}</strong>`;
                }

                let response = `<div class="analysis-section">
                    <h4>üîç Recherche : "${keyword}"</h4>
                    <p>${results.length} r√©sultat(s) trouv√©(s)</p>
                </div>`;

                results.forEach((panne) => {
                    response += `
                        <div class="panne-item">
                            <strong>${panne.machine_name}</strong> - ${new Date(panne.date_created).toLocaleDateString('fr-FR')}<br>
                            <strong>Probl√®me :</strong> ${panne.problem}<br>
                            <strong>Cause :</strong> ${panne.cause}<br>
                            <strong>‚úÖ R√©solution :</strong> ${panne.resolution}
                        </div>
                    `;
                });

                return response;
            }

            getMaintenanceAdvice() {
                return `<div class="analysis-section">
                    <h4>üõ°Ô∏è Conseils de Maintenance Pr√©ventive</h4>
                </div>

                <h4>üìã Recommandations G√©n√©rales :</h4>

                <div class="panne-item">
                    <strong>1. Inspection Quotidienne</strong><br>
                    ‚Ä¢ V√©rifier les niveaux (huile, eau, produits)<br>
                    ‚Ä¢ √âcouter les bruits anormaux<br>
                    ‚Ä¢ Contr√¥ler les temp√©ratures<br>
                    ‚Ä¢ V√©rifier l'absence de fuites
                </div>

                <div class="panne-item">
                    <strong>2. Maintenance Hebdomadaire</strong><br>
                    ‚Ä¢ Nettoyage des capteurs<br>
                    ‚Ä¢ V√©rification des connexions √©lectriques<br>
                    ‚Ä¢ Test des alarmes<br>
                    ‚Ä¢ Inspection visuelle des courroies et cha√Ænes
                </div>

                <div class="panne-item">
                    <strong>3. Maintenance Mensuelle</strong><br>
                    ‚Ä¢ Calibration des sondes de temp√©rature<br>
                    ‚Ä¢ Graissage des √©l√©ments m√©caniques<br>
                    ‚Ä¢ V√©rification des serrages<br>
                    ‚Ä¢ Test des syst√®mes de s√©curit√©
                </div>

                <div class="panne-item">
                    <strong>4. Maintenance Trimestrielle</strong><br>
                    ‚Ä¢ Remplacement des filtres<br>
                    ‚Ä¢ V√©rification des roulements<br>
                    ‚Ä¢ Test approfondi des automatismes<br>
                    ‚Ä¢ Analyse vibratoire si disponible
                </div>

                <div class="analysis-section">
                    <h4>üí° Points d'Attention en Agroalimentaire :</h4>
                    <p>‚Ä¢ Respect des normes HACCP lors de toute intervention</p>
                    <p>‚Ä¢ Nettoyage et d√©sinfection apr√®s chaque maintenance</p>
                    <p>‚Ä¢ Utilisation de lubrifiants agr√©√©s contact alimentaire</p>
                    <p>‚Ä¢ Documentation compl√®te de chaque intervention</p>
                </div>`;
            }

            getFrequentIssues() {
                const machines = {};
                db.getAll().forEach(panne => {
                    machines[panne.machine_name] = (machines[panne.machine_name] || 0) + 1;
                });

                const sorted = Object.entries(machines).sort((a, b) => b[1] - a[1]);

                let response = `<div class="analysis-section">
                    <h4>üìà Statistiques des Pannes</h4>
                    <p>Total de pannes enregistr√©es : ${db.getAll().length}</p>
                </div>

                <h4>üèÜ Machines avec le plus de pannes :</h4>`;

                sorted.forEach(([machine, count], index) => {
                    response += `
                        <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Historique ${machine}')">
                            <strong>#${index + 1} - ${machine}</strong><br>
                            ${count} panne(s) enregistr√©e(s)<br>
                            <span style="color: #2a5298;">‚Üí Voir l'historique complet</span>
                        </div>
                    `;
                });

                return response;
            }

            getGeneralHelp() {
                return `<div class="analysis-section">
                    <h4>üëã Comment puis-je vous aider ?</h4>
                </div>

                <h4>üí¨ Exemples de questions :</h4>

                <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Historique du Pasteurisateur')">
                    ‚Ä¢ "Historique du Pasteurisateur"<br>
                    <small>Voir toutes les pannes d'une machine sp√©cifique</small>
                </div>

                <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Probl√®mes de temp√©rature')">
                    ‚Ä¢ "Probl√®mes de temp√©rature"<br>
                    <small>Rechercher toutes les pannes li√©es √† la temp√©rature</small>
                </div>

                <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Maintenance pr√©ventive')">
                    ‚Ä¢ "Maintenance pr√©ventive"<br>
                    <small>Obtenir des conseils de maintenance</small>
                </div>

                <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Pannes fr√©quentes')">
                    ‚Ä¢ "Pannes fr√©quentes"<br>
                    <small>Voir les statistiques et machines probl√©matiques</small>
                </div>

                <div class="analysis-section">
                    <h4>üìä Base de donn√©es actuelle :</h4>
                    <p>‚Ä¢ ${db.getAll().length} pannes enregistr√©es</p>
                    <p>‚Ä¢ ${db.getMachineNames().length} machines r√©f√©renc√©es</p>
                </div>`;
            }
        }

        const ai = new LocalAI();

        // Fonctions d'interface
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            const tabs = {
                'chat': 'chatTab',
                'machines': 'machinesTab',
                'add': 'addTab',
                'history': 'historyTab',
                'export': 'exportTab'
            };

            document.getElementById(tabs[tabName]).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName)) {
                    btn.classList.add('active');
                }
            });

            if (tabName === 'machines') loadMachines();
            if (tabName === 'history') loadHistory();
        }

        function loadMachines() {
            const machines = db.getMachineNames();
            const container = document.getElementById('machinesList');
            
            container.innerHTML = machines.map(machine => {
                const pannes = db.getByMachine(machine);
                return `
                    <div class="machine-card" onclick="viewMachineHistory('${machine}')">
                        <h4>üè≠ ${machine}</h4>
                        <p style="color: #666; margin-top: 8px;">
                            ${pannes.length} panne(s) enregistr√©e(s)
                        </p>
                    </div>
                `;
            }).join('');
        }

        function filterMachines() {
            const search = document.getElementById('machineSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.machine-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        function loadHistory() {
            const data = db.getAll();
            const container = document.getElementById('historyList');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">Aucune panne enregistr√©e</p>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Machine</th>
                            <th>Probl√®me</th>
                            <th>Cause</th>
                            <th>R√©solution</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                <td>${new Date(item.date_created).toLocaleDateString('fr-FR')}</td>
                                <td><strong>${item.machine_name}</strong></td>
                                <td>${item.problem}</td>
                                <td>${item.cause}</td>
                                <td>${item.resolution}</td>
                                <td>
                                    <button class="delete-btn" onclick="deletePanne(${item.id})">üóëÔ∏è Supprimer</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function addBreakdown(event) {
            event.preventDefault();
            
            const alertDiv = document.getElementById('addAlert');
            const newItem = {
                machine_name: document.getElementById('machineName').value,
                problem: document.getElementById('problem').value,
                cause: document.getElementById('cause').value,
                resolution: document.getElementById('resolution').value
            };

            db.add(newItem);
            
            alertDiv.innerHTML = '<div class="alert alert-success">‚úÖ Panne enregistr√©e avec succ√®s !</div>';
            document.getElementById('breakdownForm').reset();
            
            setTimeout(() => alertDiv.innerHTML = '', 3000);
        }

        function deletePanne(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette panne ?')) {
                db.delete(id);
                loadHistory();
            }
        }

        function viewMachineHistory(machineName) {
            userInput.value = `Historique de ${machineName}`;
            showTab('chat');
            setTimeout(() => sendMessage(), 100);
        }

        function askQuestion(question) {
            userInput.value = question;
            showTab('chat');
            setTimeout(() => sendMessage(), 100);
        }

        // Chat
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const loading = document.getElementById('loading');

        function addMessage(content, role) {
            const welcomeMsg = chatContainer.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'T' : 'ü§ñ';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatContainer.appendChild(messageDiv);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            userInput.disabled = true;
            sendBtn.disabled = true;

            addMessage(message, 'user');
            userInput.value = '';

            loading.classList.add('active');

            setTimeout(() => {
                const response = ai.analyzeQuery(message);
                addMessage(response, 'assistant');
                
                loading.classList.remove('active');
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }, 500);
        }

        // Export / Import
        function exportJSON() {
            const data = db.exportData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `maintenance_pannes_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCSV() {
            const data = db.exportData();
            const headers = ['ID', 'Machine', 'Probl√®me', 'Cause', 'R√©solution', 'Date'];
            const rows = data.map(item => [
                item.id,
                `"${item.machine_name}"`,
                `"${item.problem}"`,
                `"${item.cause}"`,
                `"${item.resolution}"`,
                item.date_created
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `maintenance_pannes_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportSQL() {
            const data = db.exportData();
            let sql = `-- Export Maintenance Agroalimentaire\n`;
            sql += `-- Date: ${new Date().toLocaleString('fr-FR')}\n\n`;
            sql += `CREATE TABLE IF NOT EXISTS pannes (\n`;
            sql += `    id INT PRIMARY KEY,\n`;
            sql += `    machine_name VARCHAR(255),\n`;
            sql += `    problem TEXT,\n`;
            sql += `    cause TEXT,\n`;
            sql += `    resolution TEXT,\n`;
            sql += `    date_created DATETIME\n`;
            sql += `);\n\n`;

            data.forEach(item => {
                sql += `INSERT INTO pannes (id, machine_name, problem, cause, resolution, date_created) VALUES (\n`;
                sql += `    ${item.id},\n`;
                sql += `    '${item.machine_name.replace(/'/g, "''")}',\n`;
                sql += `    '${item.problem.replace(/'/g, "''")}',\n`;
                sql += `    '${item.cause.replace(/'/g, "''")}',\n`;
                sql += `    '${item.resolution.replace(/'/g, "''")}',\n`;
                sql += `    '${item.date_created}'\n`;
                sql += `);\n\n`;
            });

            const blob = new Blob([sql], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `maintenance_pannes_${new Date().toISOString().slice(0, 10)}.sql`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importJSON() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Veuillez s√©lectionner un fichier JSON');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm(`Importer ${data.length} pannes ? Cela remplacera les donn√©es actuelles.`)) {
                        db.importData(data);
                        alert('‚úÖ Import r√©ussi !');
                        fileInput.value = '';
                    }
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import : fichier invalide');
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if (confirm('R√©initialiser avec les donn√©es d\'exemple ? Cela supprimera vos donn√©es actuelles.')) {
                db.reset();
                alert('‚úÖ Donn√©es r√©initialis√©es !');
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è ATTENTION : Supprimer TOUTES les donn√©es ? Cette action est irr√©versible !')) {
                if (confirm('√ätes-vous vraiment s√ªr ? Les donn√©es seront perdues d√©finitivement.')) {
                    db.clear();
                    alert('üóëÔ∏è Toutes les donn√©es ont √©t√© supprim√©es');
                }
            }
        }

        // Initialisation
        window.addEventListener('load', () => {
            userInput.focus();
        });
    </script>
</body>
</html>