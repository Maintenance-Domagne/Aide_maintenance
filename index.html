<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant IA - Maintenance Agroalimentaire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        .sidebar h2 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 3px solid #2a5298;
            padding-bottom: 10px;
        }

        .quick-action {
            background: #f0f4f8;
            border: 2px solid #e0e7ef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action:hover {
            background: #e3edf7;
            border-color: #2a5298;
            transform: translateX(5px);
        }

        .quick-action h3 {
            color: #1e3c72;
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px 30px;
            border-bottom: 4px solid #f39c12;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e7ef;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #1e3c72;
            border-bottom-color: #2a5298;
            background: white;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .chat-container {
            padding: 25px;
            background: #f8f9fa;
            min-height: 100%;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #2a5298;
        }

        .message.assistant .message-avatar {
            background: #27ae60;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 15px;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: #2a5298;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e7ef;
            border-bottom-left-radius: 5px;
        }

        .input-area {
            padding: 20px 25px;
            background: white;
            border-top: 2px solid #e0e7ef;
        }

        .input-container {
            display: flex;
            gap: 12px;
        }

        #userInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e7ef;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }

        #userInput:focus {
            border-color: #2a5298;
        }

        #sendBtn {
            padding: 15px 35px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        #sendBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        #sendBtn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1e3c72;
            font-weight: bold;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e7ef;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 30px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e7ef;
        }

        .data-table th {
            background: #f0f4f8;
            color: #1e3c72;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .machine-card {
            background: white;
            border: 2px solid #e0e7ef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .machine-card:hover {
            border-color: #2a5298;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .machine-card h4 {
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .loading-dots span {
            animation: blink 1.4s infinite;
            font-size: 1.5em;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        .welcome-message {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .welcome-message h2 {
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e0e7ef;
            border-radius: 25px;
            font-size: 1em;
        }

        .sql-info {
            background: #f0f4f8;
            border-left: 4px solid #2a5298;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .sql-info h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .sql-info pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9em;
        }

        .analysis-section {
            background: #e8f5e9;
            border-left: 4px solid #27ae60;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .analysis-section h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .panne-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 5px;
            border-left: 3px solid #2a5298;
        }

        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>üîß Actions Rapides</h2>
            
            <div class="quick-action" onclick="showTab('chat')">
                <h3>üí¨ Assistant IA</h3>
            </div>

            <div class="quick-action" onclick="showTab('machines')">
                <h3>üè≠ Liste des Machines</h3>
            </div>

            <div class="quick-action" onclick="showTab('add')">
                <h3>‚ûï Ajouter une Panne</h3>
            </div>

            <div class="quick-action" onclick="showTab('history')">
                <h3>üìä Historique Complet</h3>
            </div>

            <div class="quick-action" onclick="showTab('database')">
                <h3>üíæ Structure SQL</h3>
            </div>

            <div class="quick-action" onclick="askQuestion('Quelles sont les pannes les plus fr√©quentes ?')">
                <h3>üìà Pannes Fr√©quentes</h3>
            </div>

            <div class="quick-action" onclick="askQuestion('Quels sont les conseils de maintenance pr√©ventive ?')">
                <h3>üõ°Ô∏è Maintenance Pr√©ventive</h3>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>ü§ñ Assistant IA - Maintenance Domagn√©</h1>
                <p>Base de donn√©es des pannes et r√©solutions</p>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('chat')">üí¨ Assistant IA</button>
                <button class="tab" onclick="showTab('machines')">üè≠ Machines</button>
                <button class="tab" onclick="showTab('add')">‚ûï Ajouter</button>
                <button class="tab" onclick="showTab('history')">üìä Historique</button>
                <button class="tab" onclick="showTab('database')">üíæ Base SQL</button>
            </div>

            <!-- Tab Chat -->
            <div id="chatTab" class="tab-content active">
                <div class="chat-container" id="chatContainer">
                    <div class="welcome-message">
                        <h2>Bienvenue sur votre assistant de maintenance !</h2>
                        <p>Demandez-moi l'historique d'une machine ou des conseils de d√©pannage.</p>
                        <p><strong>Exemples :</strong></p>
                        <p>‚Ä¢ "Historique du Pasteurisateur"</p>
                        <p>‚Ä¢ "Probl√®mes de temp√©rature"</p>
                        <p>‚Ä¢ "Comment entretenir le CIP ?"</p>
                    </div>
                </div>
                <div class="loading" id="loading">
                    <div class="loading-dots">
                        <span>‚Ä¢</span>
                        <span>‚Ä¢</span>
                        <span>‚Ä¢</span>
                    </div>
                    L'assistant analyse...
                </div>
                <div class="input-area">
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="userInput" 
                            placeholder="Posez votre question..."
                            onkeypress="if(event.key === 'Enter') sendMessage()"
                        >
                        <button id="sendBtn" onclick="sendMessage()">Envoyer</button>
                    </div>
                </div>
            </div>

            <!-- Tab Machines -->
            <div id="machinesTab" class="tab-content">
                <div style="padding: 25px;">
                    <h2>Liste des Machines</h2>
                    <div class="search-box">
                        <input type="text" id="machineSearch" placeholder="üîç Rechercher..." onkeyup="filterMachines()">
                    </div>
                    <div id="machinesList"></div>
                </div>
            </div>

            <!-- Tab Ajout -->
            <div id="addTab" class="tab-content">
                <div style="padding: 25px;">
                    <h2>Ajouter une Panne</h2>
                    <form id="breakdownForm" onsubmit="addBreakdown(event)">
                        <div class="form-group">
                            <label>Nom de la Machine *</label>
                            <input type="text" id="machineName" required placeholder="Ex: Pasteurisateur">
                        </div>
                        <div class="form-group">
                            <label>Probl√®me Rencontr√© *</label>
                            <textarea id="problem" required placeholder="D√©crivez le probl√®me..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Cause *</label>
                            <textarea id="cause" required placeholder="Cause identifi√©e..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>R√©solution *</label>
                            <textarea id="resolution" required placeholder="Solution appliqu√©e..."></textarea>
                        </div>
                        <button type="submit" class="btn">üìù Enregistrer</button>
                    </form>
                </div>
            </div>

            <!-- Tab Historique -->
            <div id="historyTab" class="tab-content">
                <div style="padding: 25px;">
                    <h2>Historique des Pannes</h2>
                    <div id="historyList"></div>
                </div>
            </div>

            <!-- Tab Base de donn√©es -->
            <div id="databaseTab" class="tab-content">
                <div style="padding: 25px;">
                    <h2>Structure de la Base de Donn√©es MySQL</h2>
                    
                    <div class="sql-info">
                        <h3>üìã Cr√©ation de la Table</h3>
                        <pre>CREATE TABLE pannes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    machine_name VARCHAR(255) NOT NULL,
    problem TEXT NOT NULL,
    cause TEXT NOT NULL,
    resolution TEXT NOT NULL,
    date_created TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);</pre>
                    </div>

                    <div class="sql-info">
                        <h3>‚ûï Insertion de Donn√©es</h3>
                        <pre>INSERT INTO pannes (machine_name, problem, cause, resolution) 
VALUES ('Pasteurisateur', 'Temp√©rature instable', 'Sonde PT100 d√©fectueuse', 'Remplacement de la sonde');</pre>
                    </div>

                    <div class="sql-info">
                        <h3>üîç Recherche par Machine</h3>
                        <pre>SELECT * FROM pannes 
WHERE machine_name = 'Pasteurisateur' 
ORDER BY date_created DESC;</pre>
                    </div>

                    <div class="sql-info">
                        <h3>üìä Statistiques</h3>
                        <pre>SELECT machine_name, COUNT(*) as total_pannes 
FROM pannes 
GROUP BY machine_name 
ORDER BY total_pannes DESC;</pre>
                    </div>

                    <button class="btn" onclick="downloadSQL()">üì• T√©l√©charger le Script SQL</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Base de donn√©es
        class Database {
            constructor() {
                this.data = [];
                this.initData();
            }

            initData() {
                const savedData = localStorage.getItem('pannes_db');
                if (savedData) {
                    this.data = JSON.parse(savedData);
                } else {
                    this.data = [
                        {
                            id: 1,
                            machine_name: 'D√©palettiseur',
                            problem: 'Probl√®me en sortie, √©vacuation des caisses',
                            cause: 'Cellules de detection encrass√©es o√π d√©regl√©es',
                            resolution: 'R√©glages et nettoyage des cellules de d√©tection',
                            date_created: '2026-02-10 13:00:00'
                        },
                        {
                            id: 2,
                            machine_name: 'D√©palettiseur',
                            problem: 'D√©faut noeud profinet',
                            cause: 'Recepteurs, c√¢bles ou liaison profinet d√©fectueuse',
                            resolution: 'R√©paration du c√¢ble et de la prise profinet du bras intercalaire',
                            date_created: '2026-02-10 13:00:00'
                        },
                        {
                            id: 3,
                            machine_name: 'D√©palettiseur',
                            problem: 'D√©faut cellule "time out"',
                            cause: 'Cellules encrass√©es ou d√©regl√©es',
                            resolution: 'Nettoyage et r√©glage des cellules de d√©tection',
                            date_created: '2026-02-10 13:00:00'
                        },
                        {
                            id: 4,
                            machine_name: '',
                            problem: '',
                            cause: '',
                            resolution: '',
                            date_created: ''
                        },
                        {
                            id: 5,
                            machine_name: '',
                            problem: '',
                            cause: '',
                            resolution: '',
                            date_created: ''
                        },
                        {
                            id: 6,
                            machine_name: '',
                            problem: '',
                            cause: '',
                            resolution: '',
                            date_created: ''
                        },
                        {
                            id: 7,
                            machine_name: '',
                            problem: '',
                            cause: '',
                            resolution: '',
                            date_created: ''
                        },
                        {
                            id: 8,
                            machine_name: '',
                            problem: '',
                            cause: '',
                            resolution: '',
                            date_created: ''
                        }
                    ];
                    this.save();
                }
            }

            save() {
                localStorage.setItem('pannes_db', JSON.stringify(this.data));
            }

            getAll() {
                return this.data;
            }

            getByMachine(machineName) {
                return this.data.filter(item => 
                    item.machine_name.toLowerCase().includes(machineName.toLowerCase())
                );
            }

            add(item) {
                const id = this.data.length > 0 ? Math.max(...this.data.map(d => d.id)) + 1 : 1;
                const newItem = {
                    id,
                    ...item,
                    date_created: new Date().toISOString().slice(0, 19).replace('T', ' ')
                };
                this.data.unshift(newItem);
                this.save();
                return newItem;
            }

            getMachineNames() {
                const names = [...new Set(this.data.map(d => d.machine_name))];
                return names.sort();
            }

            search(query) {
                query = query.toLowerCase();
                return this.data.filter(item => 
                    item.machine_name.toLowerCase().includes(query) ||
                    item.problem.toLowerCase().includes(query) ||
                    item.cause.toLowerCase().includes(query) ||
                    item.resolution.toLowerCase().includes(query)
                );
            }
        }

        const db = new Database();
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const loading = document.getElementById('loading');

        // Assistant IA local
        class LocalAI {
            analyzeQuery(query) {
                const machines = db.getMachineNames();
                let machineFound = null;

                // Chercher si une machine est mentionn√©e
                for (let machine of machines) {
                    if (query.toLowerCase().includes(machine.toLowerCase())) {
                        machineFound = machine;
                        break;
                    }
                }

                // Si machine trouv√©e, retourner son historique
                if (machineFound) {
                    return this.generateMachineReport(machineFound);
                }

                // Recherche par mots-cl√©s
                if (query.match(/temp√©rature|thermique|chaleur|froid/i)) {
                    return this.searchByKeyword('temp√©rature');
                }

                if (query.match(/pression|fuite|circuit/i)) {
                    return this.searchByKeyword('pression');
                }

                if (query.match(/capteur|sonde|d√©tecteur/i)) {
                    return this.searchByKeyword('capteur');
                }

                if (query.match(/maintenance|entretien|pr√©ventive/i)) {
                    return this.getMaintenanceAdvice();
                }

                if (query.match(/fr√©quent|r√©current|souvent/i)) {
                    return this.getFrequentIssues();
                }

                // R√©ponse par d√©faut
                return this.getGeneralHelp();
            }

            generateMachineReport(machineName) {
                const pannes = db.getByMachine(machineName);

                if (pannes.length === 0) {
                    return `<strong>Machine : ${machineName}</strong><br><br>Aucune panne enregistr√©e pour cette machine.`;
                }

                let response = `<div class="analysis-section">
                    <h4>üìä Analyse : ${machineName}</h4>
                    <p><strong>Total de pannes :</strong> ${pannes.length}</p>
                </div>`;

                response += `<h4>üîç Historique des Pannes :</h4>`;

                pannes.forEach((panne, index) => {
                    response += `
                        <div class="panne-item">
                            <strong>Panne #${index + 1}</strong> - ${new Date(panne.date_created).toLocaleDateString('fr-FR')}<br>
                            <strong>Probl√®me :</strong> ${panne.problem}<br>
                            <strong>Cause :</strong> ${panne.cause}<br>
                            <strong>‚úÖ R√©solution :</strong> ${panne.resolution}
                        </div>
                    `;
                });

                // Analyse des patterns
                const causes = pannes.map(p => p.cause.toLowerCase());
                const hasTempIssues = causes.some(c => c.includes('temp√©rature') || c.includes('sonde'));
                const hasMechIssues = causes.some(c => c.includes('roulement') || c.includes('courroie'));

                if (pannes.length > 1) {
                    response += `<div class="analysis-section">
                        <h4>üí° Recommandations :</h4>`;
                    
                    if (hasTempIssues) {
                        response += `<p>‚Ä¢ V√©rifier r√©guli√®rement les sondes de temp√©rature (calibration mensuelle recommand√©e)</p>`;
                    }
                    if (hasMechIssues) {
                        response += `<p>‚Ä¢ Planifier une maintenance pr√©ventive des √©l√©ments m√©caniques</p>`;
                    }
                    
                    response += `<p>‚Ä¢ Documenter toutes les interventions pour suivre l'√©volution</p>
                        <p>‚Ä¢ Former les techniciens aux sp√©cificit√©s de cette machine</p>
                    </div>`;
                }

                return response;
            }

            searchByKeyword(keyword) {
                const results = db.search(keyword);
                
                if (results.length === 0) {
                    return `Aucune panne trouv√©e concernant : <strong>${keyword}</strong>`;
                }

                let response = `<div class="analysis-section">
                    <h4>üîç Recherche : "${keyword}"</h4>
                    <p>${results.length} r√©sultat(s) trouv√©(s)</p>
                </div>`;

                results.forEach((panne, index) => {
                    response += `
                        <div class="panne-item">
                            <strong>${panne.machine_name}</strong> - ${new Date(panne.date_created).toLocaleDateString('fr-FR')}<br>
                            <strong>Probl√®me :</strong> ${panne.problem}<br>
                            <strong>Cause :</strong> ${panne.cause}<br>
                            <strong>‚úÖ R√©solution :</strong> ${panne.resolution}
                        </div>
                    `;
                });

                return response;
            }

            getMaintenanceAdvice() {
                return `<div class="analysis-section">
                    <h4>üõ°Ô∏è Conseils de Maintenance Pr√©ventive</h4>
                </div>

                <h4>üìã Recommandations G√©n√©rales :</h4>

                <div class="panne-item">
                    <strong>1. Inspection Quotidienne</strong><br>
                    ‚Ä¢ V√©rifier les niveaux (huile, eau, produits)<br>
                    ‚Ä¢ √âcouter les bruits anormaux<br>
                    ‚Ä¢ Contr√¥ler les temp√©ratures<br>
                    ‚Ä¢ V√©rifier l'absence de fuites
                </div>

                <div class="panne-item">
                    <strong>2. Maintenance Hebdomadaire</strong><br>
                    ‚Ä¢ Nettoyage des capteurs<br>
                    ‚Ä¢ V√©rification des connexions √©lectriques<br>
                    ‚Ä¢ Test des alarmes<br>
                    ‚Ä¢ Inspection visuelle des courroies et cha√Ænes
                </div>

                <div class="panne-item">
                    <strong>3. Maintenance Mensuelle</strong><br>
                    ‚Ä¢ Calibration des sondes de temp√©rature<br>
                    ‚Ä¢ Graissage des √©l√©ments m√©caniques<br>
                    ‚Ä¢ V√©rification des serrages<br>
                    ‚Ä¢ Test des syst√®mes de s√©curit√©
                </div>

                <div class="panne-item">
                    <strong>4. Maintenance Trimestrielle</strong><br>
                    ‚Ä¢ Remplacement des filtres<br>
                    ‚Ä¢ V√©rification des roulements<br>
                    ‚Ä¢ Test approfondi des automatismes<br>
                    ‚Ä¢ Analyse vibratoire si disponible
                </div>

                <div class="analysis-section">
                    <h4>üí° Points d'Attention Sp√©cifiques en Agroalimentaire :</h4>
                    <p>‚Ä¢ Respect des normes HACCP lors de toute intervention</p>
                    <p>‚Ä¢ Nettoyage et d√©sinfection apr√®s chaque maintenance</p>
                    <p>‚Ä¢ Utilisation de lubrifiants agr√©√©s contact alimentaire</p>
                    <p>‚Ä¢ Documentation compl√®te de chaque intervention</p>
                </div>`;
            }

            getFrequentIssues() {
                const machines = {};
                db.getAll().forEach(panne => {
                    machines[panne.machine_name] = (machines[panne.machine_name] || 0) + 1;
                });

                const sorted = Object.entries(machines).sort((a, b) => b[1] - a[1]);

                let response = `<div class="analysis-section">
                    <h4>üìà Statistiques des Pannes</h4>
                    <p>Total de pannes enregistr√©es : ${db.getAll().length}</p>
                </div>

                <h4>üèÜ Machines avec le plus de pannes :</h4>`;

                sorted.forEach(([machine, count], index) => {
                    response += `
                        <div class="panne-item">
                            <strong>#${index + 1} - ${machine}</strong><br>
                            ${count} panne(s) enregistr√©e(s)<br>
                            <span style="color: #2a5298; cursor: pointer;" onclick="askQuestion('Historique ${machine}')">
                                ‚Üí Voir l'historique complet
                            </span>
                        </div>
                    `;
                });

                return response;
            }

            getGeneralHelp() {
                return `<div class="analysis-section">
                    <h4>üëã Comment puis-je vous aider ?</h4>
                </div>

                <h4>üí¨ Exemples de questions :</h4>

                <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Historique du Pasteurisateur')">
                    ‚Ä¢ "Historique du Pasteurisateur"<br>
                    <small>Voir toutes les pannes d'une machine sp√©cifique</small>
                </div>

                <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Probl√®mes de temp√©rature')">
                    ‚Ä¢ "Probl√®mes de temp√©rature"<br>
                    <small>Rechercher toutes les pannes li√©es √† la temp√©rature</small>
                </div>

                <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Maintenance pr√©ventive')">
                    ‚Ä¢ "Maintenance pr√©ventive"<br>
                    <small>Obtenir des conseils de maintenance</small>
                </div>

                <div class="panne-item" style="cursor: pointer;" onclick="askQuestion('Pannes fr√©quentes')">
                    ‚Ä¢ "Pannes fr√©quentes"<br>
                    <small>Voir les statistiques et machines probl√©matiques</small>
                </div>

                <div class="analysis-section">
                    <h4>üìä Base de donn√©es actuelle :</h4>
                    <p>‚Ä¢ ${db.getAll().length} pannes enregistr√©es</p>
                    <p>‚Ä¢ ${db.getMachineNames().length} machines r√©f√©renc√©es</p>
                </div>`;
            }
        }

        const ai = new LocalAI();

        // Fonctions d'interface
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            const tabs = {
                'chat': 'chatTab',
                'machines': 'machinesTab',
                'add': 'addTab',
                'history': 'historyTab',
                'database': 'databaseTab'
            };

            document.getElementById(tabs[tabName]).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'machines') loadMachines();
            if (tabName === 'history') loadHistory();
        }

        function loadMachines() {
            const machines = db.getMachineNames();
            const container = document.getElementById('machinesList');
            
            container.innerHTML = machines.map(machine => {
                const pannes = db.getByMachine(machine);
                return `
                    <div class="machine-card" onclick="viewMachineHistory('${machine}')">
                        <h4>üè≠ ${machine}</h4>
                        <p style="color: #666; margin-top: 8px;">
                            ${pannes.length} panne(s) enregistr√©e(s)
                        </p>
                    </div>
                `;
            }).join('');
        }

        function filterMachines() {
            const search = document.getElementById('machineSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.machine-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        function loadHistory() {
            const data = db.getAll();
            const container = document.getElementById('historyList');
            
            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Machine</th>
                            <th>Probl√®me</th>
                            <th>Cause</th>
                            <th>R√©solution</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                <td>${new Date(item.date_created).toLocaleDateString('fr-FR')}</td>
                                <td><strong>${item.machine_name}</strong></td>
                                <td>${item.problem}</td>
                                <td>${item.cause}</td>
                                <td>${item.resolution}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function addBreakdown(event) {
            event.preventDefault();
            
            const newItem = {
                machine_name: document.getElementById('machineName').value,
                problem: document.getElementById('problem').value,
                cause: document.getElementById('cause').value,
                resolution: document.getElementById('resolution').value
            };

            db.add(newItem);
            alert('‚úÖ Panne enregistr√©e avec succ√®s !');
            document.getElementById('breakdownForm').reset();
        }

        function viewMachineHistory(machineName) {
            userInput.value = `Historique de ${machineName}`;
            showTab('chat');
            setTimeout(() => sendMessage(), 100);
        }

        function askQuestion(question) {
            userInput.value = question;
            showTab('chat');
            setTimeout(() => sendMessage(), 100);
        }

        // Chat
        function addMessage(content, role) {
            const welcomeMsg = chatContainer.querySelector('.welcome-message');
            if (welcomeMsg) welcomeMsg.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'T' : 'ü§ñ';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatContainer.appendChild(messageDiv);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            userInput.disabled = true;
            sendBtn.disabled = true;

            addMessage(message, 'user');
            userInput.value = '';

            loading.classList.add('active');

            // Simuler un d√©lai de traitement
            setTimeout(() => {
                const response = ai.analyzeQuery(message);
                addMessage(response, 'assistant');
                
                loading.classList.remove('active');
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }, 500);
        }

        function downloadSQL() {
            const sqlContent = `-- Base de donn√©es Maintenance Agroalimentaire
-- Date: ${new Date().toLocaleDateString('fr-FR')}

CREATE DATABASE IF NOT EXISTS maintenance_agro;
USE maintenance_agro;

-- Cr√©ation de la table
CREATE TABLE pannes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    machine_name VARCHAR(255) NOT NULL,
    problem TEXT NOT NULL,
    cause TEXT NOT NULL,
    resolution TEXT NOT NULL,
    date_created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_machine (machine_name),
    INDEX idx_date (date_created)
);

-- Insertion des donn√©es
${db.getAll().map(item => `INSERT INTO pannes (machine_name, problem, cause, resolution, date_created) 
VALUES (
    '${item.machine_name.replace(/'/g, "''")}',
    '${item.problem.replace(/'/g, "''")}',
    '${item.cause.replace(/'/g, "''")}',
    '${item.resolution.replace(/'/g, "''")}',
    '${item.date_created}'
);`).join('\n')}

-- Requ√™tes utiles

-- 1. Historique complet par machine
SELECT * FROM pannes 
WHERE machine_name = 'Pasteurisateur' 
ORDER BY date_created DESC;

-- 2. Statistiques par machine
SELECT machine_name, COUNT(*) as total_pannes 
FROM pannes 
GROUP BY machine_name 
ORDER BY total_pannes DESC;

-- 3. Pannes r√©centes (30 derniers jours)
SELECT * FROM pannes 
WHERE date_created >= DATE_SUB(NOW(), INTERVAL 30 DAY)
ORDER BY date_created DESC;

-- 4. Recherche par mot-cl√©
SELECT * FROM pannes 
WHERE problem LIKE '%temp√©rature%' 
   OR cause LIKE '%temp√©rature%';

-- 5. Machines les plus probl√©matiques
SELECT machine_name, COUNT(*) as nb_pannes 
FROM pannes 
GROUP BY machine_name 
HAVING nb_pannes > 1
ORDER BY nb_pannes DESC;
`;

            const blob = new Blob([sqlContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'maintenance_agroalimentaire.sql';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialisation
        window.addEventListener('load', () => {
            userInput.focus();
        });
    </script>
</body>
</html>